# Migration `20200615082534-initial`

This migration has been generated by Andrii Soldatenko at 6/15/2020, 8:25:34 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Role" AS ENUM ('SYSTEM_ADMIN', 'SYSTEM_EDITOR', 'SYSTEM_VIEWER', 'WORKSPACE_ADMIN', 'WORKSPACE_EDITOR', 'WORKSPACE_VIEWER', 'DEPLOYMENT_ADMIN', 'DEPLOYMENT_EDITOR', 'DEPLOYMENT_VIEWER', 'USER');

CREATE TYPE "InviteSource" AS ENUM ('SYSTEM', 'WORKSPACE');

CREATE TABLE "houston$default"."User" (
"avatarUrl" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"fullName" text   ,"id" text  NOT NULL ,"status" text   ,"updatedAt" timestamp(3)  NOT NULL ,"username" text   ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."RoleBinding" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"deploymentId" text   ,"id" text  NOT NULL ,"role" text   ,"serviceAccountId" text   ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,"workspaceId" text   ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."Email" (
"address" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"primary" boolean   ,"token" text   ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,"verified" boolean   ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."LocalCredential" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"password" text   ,"resetToken" text   ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."OAuthCredential" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"expiresAt" timestamp(3)   ,"id" text  NOT NULL ,"oauthProvider" text  NOT NULL ,"oauthUserId" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."InviteToken" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"email" text  NOT NULL ,"id" text  NOT NULL ,"role" text   ,"source" "InviteSource" NOT NULL ,"token" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"workspaceId" text   ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."ServiceAccount" (
"active" boolean   ,"apiKey" text   ,"category" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"label" text   ,"lastUsedAt" timestamp(3)   ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."Workspace" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"description" text   ,"id" text  NOT NULL ,"isSuspended" boolean   ,"label" text   ,"stripeCustomerId" text   ,"trialEndsAt" text   ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."Deployment" (
"airflowVersion" text   ,"alertEmails" text []  ,"canary" boolean   ,"config" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"description" text   ,"elasticsearchPassword" text   ,"extraAu" integer   ,"id" text  NOT NULL ,"label" text   ,"registryPassword" text   ,"releaseName" text   ,"updatedAt" timestamp(3)  NOT NULL ,"version" text   ,"workspaceId" text   ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."DockerImage" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"deploymentId" text  NOT NULL ,"digest" text  NOT NULL ,"env" text  NOT NULL ,"id" text  NOT NULL ,"labels" text  NOT NULL ,"name" text   ,"tag" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "houston$default"."PlatformRelease" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"description" text   ,"id" text  NOT NULL ,"level" text   ,"releaseDate" timestamp(3)  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"url" text   ,"version" text   ,
    PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "User.username" ON "houston$default"."User"("username")

CREATE UNIQUE INDEX "RoleBinding_serviceAccountId" ON "houston$default"."RoleBinding"("serviceAccountId")

CREATE UNIQUE INDEX "Email.address" ON "houston$default"."Email"("address")

CREATE UNIQUE INDEX "Email.token" ON "houston$default"."Email"("token")

CREATE UNIQUE INDEX "LocalCredential.resetToken" ON "houston$default"."LocalCredential"("resetToken")

CREATE UNIQUE INDEX "LocalCredential_userId" ON "houston$default"."LocalCredential"("userId")

CREATE UNIQUE INDEX "InviteToken.token" ON "houston$default"."InviteToken"("token")

CREATE UNIQUE INDEX "ServiceAccount.apiKey" ON "houston$default"."ServiceAccount"("apiKey")

CREATE UNIQUE INDEX "Deployment.releaseName" ON "houston$default"."Deployment"("releaseName")

CREATE UNIQUE INDEX "DockerImage.name" ON "houston$default"."DockerImage"("name")

CREATE UNIQUE INDEX "PlatformRelease.version" ON "houston$default"."PlatformRelease"("version")

ALTER TABLE "houston$default"."RoleBinding" ADD FOREIGN KEY ("userId")REFERENCES "houston$default"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "houston$default"."RoleBinding" ADD FOREIGN KEY ("serviceAccountId")REFERENCES "houston$default"."ServiceAccount"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "houston$default"."RoleBinding" ADD FOREIGN KEY ("workspaceId")REFERENCES "houston$default"."Workspace"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "houston$default"."RoleBinding" ADD FOREIGN KEY ("deploymentId")REFERENCES "houston$default"."Deployment"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "houston$default"."Email" ADD FOREIGN KEY ("userId")REFERENCES "houston$default"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "houston$default"."LocalCredential" ADD FOREIGN KEY ("userId")REFERENCES "houston$default"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "houston$default"."OAuthCredential" ADD FOREIGN KEY ("userId")REFERENCES "houston$default"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "houston$default"."InviteToken" ADD FOREIGN KEY ("workspaceId")REFERENCES "houston$default"."Workspace"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "houston$default"."Deployment" ADD FOREIGN KEY ("workspaceId")REFERENCES "houston$default"."Workspace"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "houston$default"."DockerImage" ADD FOREIGN KEY ("deploymentId")REFERENCES "houston$default"."Deployment"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200615082534-initial
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,182 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource db {
+  provider = "postgresql"
+  url      = env("DATABASE_URL")
+}
+
+enum Role {
+  SYSTEM_ADMIN
+  SYSTEM_EDITOR
+  SYSTEM_VIEWER
+  WORKSPACE_ADMIN
+  WORKSPACE_EDITOR
+  WORKSPACE_VIEWER
+  DEPLOYMENT_ADMIN
+  DEPLOYMENT_EDITOR
+  DEPLOYMENT_VIEWER
+  USER
+}
+
+enum InviteSource {
+  SYSTEM
+  WORKSPACE
+}
+
+model User {
+  id              String            @default(cuid()) @id
+  username        String?           @unique
+  status          String?
+  fullName        String?
+  avatarUrl       String?
+  emails          Email[]           @relation(name: "EmailToUser")
+  roleBindings    RoleBinding[]     @relation(name: "RoleBindingToUser")
+  localCredential LocalCredential?   @relation(name: "LocalCredentialToUser")
+  oauthCredentials OAuthCredential[] @relation(name: "OAuthCredentialToUser")
+  createdAt       DateTime          @default(now())
+  updatedAt       DateTime          @updatedAt
+}
+
+// Ideally this type uses a union type once prisma supports it.
+// subject: User | ServiceAccount
+// principal: Workspace | Deployment
+// TODO: check in prisma2 -> https://github.com/prisma/prisma1/issues/165
+model RoleBinding {
+  id             String          @default(cuid()) @id
+  role           String?
+  user           User            @relation(fields: [userId], name: "RoleBindingToUser")
+  userId         String
+  serviceAccount ServiceAccount? @relation(fields: [serviceAccountId], name: "RoleBindingToServiceAccount", references: id)
+  serviceAccountId String?
+  workspace      Workspace?      @relation(fields: [workspaceId], name: "RoleBindingToWorkspace")
+  workspaceId    String?
+  deployment     Deployment?     @relation(fields: [deploymentId], name: "DeploymentRoleBindings")
+  deploymentId   String?
+  createdAt      DateTime        @default(now())
+  updatedAt      DateTime        @updatedAt
+}
+
+model Email {
+  id        String   @default(cuid()) @id
+  address   String?  @unique
+  primary   Boolean?
+  token     String?  @unique
+  user      User     @relation(fields: [userId], name: "EmailToUser")
+  userId    String
+  verified  Boolean?
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+}
+
+model LocalCredential {
+  id         String   @default(cuid()) @id
+  user       User     @relation(fields: [userId], name: "LocalCredentialToUser")
+  userId     String
+  password   String?
+  resetToken String?  @unique
+  createdAt  DateTime @default(now())
+  updatedAt  DateTime @updatedAt
+}
+
+model OAuthCredential {
+  id            String    @default(cuid()) @id
+  expiresAt     DateTime?
+  oauthProvider String
+  oauthUserId   String
+  user          User      @relation(fields: [userId], name: "OAuthCredentialToUser")
+  userId        String
+  createdAt     DateTime  @default(now())
+  updatedAt     DateTime  @updatedAt
+}
+
+model InviteToken {
+  // Multi-column unique fields would be nice, but not supported yet
+  // TODO: @andriisoldatenko check prisma2
+  id        String     @default(cuid()) @id
+  email     String
+  token     String     @unique
+  source    InviteSource
+
+  // Optional. If one is specified both should be
+  workspace             Workspace?  @relation(fields: [workspaceId], references: [id])
+  workspaceId           String?
+  role      String?
+
+  createdAt DateTime   @default(now())
+  updatedAt DateTime   @updatedAt
+}
+
+model ServiceAccount {
+  id             String        @default(cuid()) @id
+  apiKey         String?       @unique
+  label          String?
+  category       String?
+  active         Boolean?
+  roleBinding    RoleBinding @relation(name: "RoleBindingToServiceAccount")
+  lastUsedAt     DateTime?
+  createdAt      DateTime      @default(now())
+  updatedAt      DateTime      @updatedAt
+}
+
+model Workspace {
+  id               String        @default(cuid()) @id
+  deployments      Deployment[]
+  description      String?
+  invites          InviteToken[]
+  label            String?
+  roleBindings     RoleBinding[] @relation(name: "RoleBindingToWorkspace")
+  stripeCustomerId String?
+  createdAt        DateTime      @default(now())
+  updatedAt        DateTime      @updatedAt
+  isSuspended      Boolean?
+  trialEndsAt      String?
+}
+
+model Deployment {
+  id                    String        @default(cuid()) @id
+  config                String?
+  description           String?
+  label                 String?
+  registryPassword      String?
+  elasticsearchPassword String?
+  releaseName           String?       @unique
+  version               String?
+  extraAu               Int?
+  airflowVersion        String?
+  alertEmails           String[]
+  roleBindings          RoleBinding[] @relation(name: "DeploymentRoleBindings")
+  workspace             Workspace?  @relation(fields: [workspaceId], references: [id])
+  workspaceId           String?
+  createdAt             DateTime      @default(now())
+  updatedAt             DateTime      @updatedAt
+  deletedAt             DateTime?
+  images                DockerImage[] @relation(name: "DeploymentDockerImages")
+  canary                Boolean?
+}
+
+model DockerImage {
+  id         String      @default(cuid()) @id
+  // Even though we only "need" the tag, to make it a unique string that we can
+  // create/update by we include repository in this too.
+  name       String?     @unique
+  labels     String
+  env        String
+  tag        String
+  digest     String
+  deployment Deployment  @relation(fields: [deploymentId], name: "DeploymentDockerImages")
+  deploymentId String
+  createdAt  DateTime    @default(now())
+}
+
+model PlatformRelease {
+  id          String   @default(cuid()) @id
+  version     String?  @unique
+  url         String?
+  description String?
+  level       String?
+  releaseDate DateTime
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @updatedAt
+}
```


